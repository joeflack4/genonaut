# E2E Test Failures - 2025-10-25

## Task List

### Image View Page Tests
- [ ] `displays image details and metadata` - image-view.spec.ts:5:3
- [ ] `navigates to tag detail page when tag chip is clicked` - image-view.spec.ts:48:3
- [ ] `back button returns to previous page` - image-view.spec.ts:110:3
- [ ] `does not show React duplicate key warnings for tags` - image-view.spec.ts:157:3

### Tag Rating Tests
- [ ] `should allow user to rate a tag` - tag-rating.spec.ts:16:3
- [ ] `should update existing rating` - tag-rating.spec.ts:85:3
- [ ] `should persist rating across page refreshes` - tag-rating.spec.ts:155:3

### Generation Tests
- [ ] `should successfully submit a generation job with real API` - generation.spec.ts:8:3

---

## Common Failure Patterns

### Pattern 1: "Test database missing gallery data" (4 tests)

**Affected Tests:**
- All Image View Page tests (4 tests)

**Error Message:**
```
Error: Test database missing gallery data (content_items)

To fix, run:
make init-test && python -m genonaut.db.demo.seed_data_gen.seed_tags_from_content --env-target test
```

**What We Know:**
- The test database (`genonaut_test`) actually HAS 100 content_items
- The API server health check works: `{"status":"healthy","database":{"status":"connected"}}`
- The gallery API endpoint returns data successfully when queried directly
- Tests navigate to `/gallery` but see empty state (`gallery-results-empty`)

**Root Cause Hypothesis:**
- The API server may be connected to the **demo database** (`genonaut_demo`) not the test database
- Process check showed: `python -m genonaut.cli_main run-api --env-target local-demo`
- Tests expect the API to be running against `local-test` database
- When tests run, they may be hitting the demo database which could be in a different state

**Potential Fixes:**
1. **Option A**: Kill demo API, start test API before running e2e tests
   - `kill <demo-api-pid>`
   - `make api-test` (runs against `genonaut_test`)
   - Run e2e tests

2. **Option B**: Check which database the current API is using
   - Add database name to health endpoint response
   - Verify test setup starts correct API server

3. **Option C**: Frontend data loading issue
   - Check if gallery page query parameters are correct
   - Verify React Query cache isn't stale
   - Check network requests in test to see what API returns

**Next Steps:**
- Verify which database is behind the current API server on port 8001
- Update health endpoint to show database name for debugging
- Ensure e2e test setup script starts API with correct database

---

### Pattern 2: Missing `gallery-sidebar-toggle` (3 tests)

**Affected Tests:**
- All Tag Rating tests (3 tests)

**Error Message:**
```
TimeoutError: locator.click: Timeout 3000ms exceeded.
Call log:
  - waiting for getByTestId('gallery-sidebar-toggle')
```

**What We Know:**
- Tests navigate to `/gallery` page
- Can't find the sidebar toggle button after 3 seconds
- This is the first interaction the tests attempt

**Root Cause Hypothesis:**
- Gallery page not loading completely
- Sidebar toggle may be conditionally rendered based on data
- Same underlying issue as Pattern 1 - gallery showing empty state
- If gallery is empty, sidebar may not render

**Potential Fixes:**
1. Same as Pattern 1 - ensure correct database is connected
2. Check if sidebar toggle is hidden when no data exists
3. Update test to handle empty state gracefully

---

### Pattern 3: Generation Job Timeout (1 test)

**Affected Tests:**
- `should successfully submit a generation job with real API` - generation.spec.ts:8:3

**Error Message:**
```
Test timeout of 10000ms exceeded.
Error: locator.waitFor: Test timeout of 10000ms exceeded.
  - waiting for locator('text=/generation .* (created|submitted|queued)/i')
    .or(locator('[role="alert"]:has-text("Success")'))
    .or(locator('text=/successfully/i')) to be visible
```

**What We Know:**
- Test fills in prompt "cat"
- Clicks "Generate" button successfully
- Waits for success OR error indicator
- Neither appears within 10 seconds
- Could be timeout, could be actual failure without error display

**Root Cause Hypothesis:**
- Generation job may be failing silently
- Database sequence issues (mentioned in test comment: "check for database sequence issues")
- Celery worker may not be running
- ComfyUI mock service may not be running
- Response not displaying in expected format

**Potential Fixes:**
1. Check Celery worker is running: `ps aux | grep celery`
2. Check ComfyUI mock service status
3. Check API logs for generation errors
4. Verify database sequences are correct after migrations
5. Check if generation job created in database: `SELECT * FROM generation_jobs ORDER BY created_at DESC LIMIT 5`
6. Increase timeout or add better error handling

---

## Individual Test Details

### Image View: displays image details and metadata

**Test File:** `frontend/tests/e2e/image-view.spec.ts:5:3`

**Test Flow:**
1. Navigate to `/gallery`
2. Wait for gallery results or empty state
3. Check if results visible, if not -> fail with "missing data" error
4. Click first image card
5. Verify navigation to `/view/{id}`
6. Verify page elements present

**Current Status:** Fails at step 3 - sees empty state despite data existing

**Investigation Needed:**
- [ ] Verify API endpoint query parameters
- [ ] Check if user_id in query matches test data
- [ ] Verify content_items have required fields for gallery display
- [ ] Check network tab in test browser to see actual API response

---

### Image View: navigates to tag detail page when tag chip is clicked

**Test File:** `frontend/tests/e2e/image-view.spec.ts:48:3`

**Test Flow:**
Same as above, plus:
6. Find and click tag chip
7. Verify navigation to `/tags/{tagName}`
8. Verify tag detail page loads

**Current Status:** Fails at step 3 (same as above)

---

### Image View: back button returns to previous page

**Test File:** `frontend/tests/e2e/image-view.spec.ts:110:3`

**Test Flow:**
Same setup, then:
6. Click back button on view page
7. Verify navigation back to `/gallery`

**Current Status:** Fails at step 3 (same as above)

---

### Image View: does not show React duplicate key warnings for tags

**Test File:** `frontend/tests/e2e/image-view.spec.ts:157:3`

**Test Flow:**
1. Listen for console warnings
2. Navigate to gallery and open image view
3. Wait for tags to render
4. Check no duplicate key warnings in console

**Current Status:** Fails at gallery load (same as above)

---

### Tag Rating: should allow user to rate a tag

**Test File:** `frontend/tests/e2e/tag-rating.spec.ts:16:3`

**Test Flow:**
1. Navigate to `/gallery`
2. Click sidebar toggle to show tags
3. Get first tag name from sidebar
4. Navigate to tag detail page
5. Rate the tag
6. Verify rating saved

**Current Status:** Fails at step 2 - can't find sidebar toggle

**Investigation Needed:**
- [ ] Check if sidebar toggle exists when gallery is empty
- [ ] Verify sidebar toggle data-testid in GalleryPage component
- [ ] Check if sidebar is conditionally rendered

---

### Tag Rating: should update existing rating

**Test File:** `frontend/tests/e2e/tag-rating.spec.ts:85:3`

**Test Flow:**
Same as above, plus:
6. Change rating
7. Verify update saved

**Current Status:** Fails at step 2 (same as above)

---

### Tag Rating: should persist rating across page refreshes

**Test File:** `frontend/tests/e2e/tag-rating.spec.ts:155:3`

**Test Flow:**
Same as rating test, plus:
7. Refresh page
8. Verify rating persists

**Current Status:** Fails at step 2 (same as above)

---

### Generation: should successfully submit a generation job with real API

**Test File:** `frontend/tests/e2e/generation.spec.ts:8:3`

**Test Flow:**
1. Navigate to `/generate`
2. Wait for form to load
3. Fill prompt with "cat"
4. Click "Generate" button
5. Wait for success OR error indicator (10s timeout)
6. Fail if error, succeed if success

**Current Status:** Fails at step 5 - timeout, neither success nor error appears

**Investigation Needed:**
- [ ] Check Celery worker status
- [ ] Check ComfyUI mock service status
- [ ] Check API logs during generation submission
- [ ] Query database for generation_jobs created during test
- [ ] Verify database sequences (generation_jobs, content_items)
- [ ] Check if generation creates duplicate key errors
- [ ] Verify notification system working

---

## Database State Investigation

### Current Setup
- Test database (`genonaut_test`): Has 100 content_items
- Demo database (`genonaut_demo`): Unknown state, possibly different data
- API server running: Connected to `local-demo` database (not `local-test`)

### Required Actions
1. Determine which database each test type should use
2. Document test database expectations
3. Add database name to API health endpoint
4. Ensure test runners start correct API server
5. Consider if tests should run against demo database instead

---

## Broken Scripts

### seed_tags_from_content.py

**Status:** Broken due to schema migration

**Error:**
```
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedColumn)
column "tags_old" does not exist
LINE 2: SELECT DISTINCT jsonb_array_elements_text(tags_old) as tag_name
```

**Cause:**
- Script references `tags_old` column
- Column was dropped in migration: `4b0146ebf04b - Drop tags_old columns`
- Script needs updating to use new tag schema (junction table `content_tags`)

**Impact:**
- Can't seed tags for test database using this script
- Tests expect tags to exist for tag rating functionality
- May need alternative seeding approach

**Fix Required:**
- Update script to query `content_tags` junction table
- Or query tags from content_items.item_metadata JSONB
- Or create new seed script for current schema
