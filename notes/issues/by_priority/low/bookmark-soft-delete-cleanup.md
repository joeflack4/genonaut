# Bookmark Soft-Delete Code Cleanup

**Priority**: Low
**Status**: Open
**Created**: 2025-11-16
**Related**: notes/bookmark-delete.md

## Overview
The bookmark deletion logic was changed from soft-delete to hard-delete to fix a unique constraint issue. The old soft-delete code and database column are still present but deprecated and should be removed in a future cleanup.

## Background
Soft-delete was causing a bug where users couldn't re-bookmark content after deleting it because:
- Soft-deleted records still violated the unique constraint `uq_bookmark_user_content(user_id, content_id, content_source_type)`
- The constraint doesn't exclude rows where `deleted_at IS NOT NULL`
- Attempting to create a new bookmark for previously-deleted content resulted in HTTP 422 errors

**Solution implemented**: Switched to hard deletion (permanent row removal) on 2025-11-16.

## What's Deprecated

### Code
1. **BookmarkRepository.soft_delete()** method in `genonaut/api/repositories/bookmark_repository.py:303-326`
   - Currently marked as DEPRECATED in docstring
   - No longer called by any active code paths
   - Can be safely removed

### Database Schema
1. **Bookmark.deleted_at** column in `genonaut/db/schema.py:1462`
   - Still exists in database schema
   - No longer used by application code
   - Can be removed via migration

2. **idx_bookmarks_user_not_deleted** partial index in `genonaut/db/schema.py:1501-1502`
   - Partial index filtering `WHERE deleted_at IS NULL`
   - No longer needed after column removal

### Query Filters
All queries that filter on `deleted_at IS NULL` can be simplified:
- `BookmarkRepository.get_by_user()` - line 49
- `BookmarkRepository.get_by_user_and_content()` - line 103
- Any other methods filtering on deleted_at

## Cleanup Checklist

### Step 1: Code Audit
- [ ] Search codebase for all references to `deleted_at` in bookmark-related code
- [ ] Verify no external code or integrations depend on soft-delete behavior
- [ ] Check if any existing migrations reference deleted_at

### Step 2: Remove Deprecated Method
- [ ] Delete `BookmarkRepository.soft_delete()` method
- [ ] Update any docstrings that mention soft-delete behavior

### Step 3: Remove Query Filters
- [ ] Remove all `.filter(Bookmark.deleted_at.is_(None))` clauses from queries
- [ ] Simplify queries that no longer need this filter

### Step 4: Database Migration
- [ ] Create Alembic migration to:
  - Drop partial index `idx_bookmarks_user_not_deleted`
  - Drop column `deleted_at` from bookmarks table
- [ ] Test migration on local databases (dev, demo, test)
- [ ] Verify all bookmark functionality still works after migration

### Step 5: Update Schema Model
- [ ] Remove `deleted_at = Column(DateTime(timezone=True), nullable=True)` from Bookmark model
- [ ] Remove partial index definition from `__table_args__`
- [ ] Update Bookmark model docstring to remove mention of deleted_at

### Step 6: Testing
- [ ] Run full test suite: `make test-all`
- [ ] Run frontend tests: `make frontend-test`
- [ ] Manually verify bookmark CRUD operations work correctly
- [ ] Check that re-bookmarking after deletion still works

## Migration Template

```python
"""Remove bookmark soft-delete column

Revision ID: <auto-generated>
Revises: <previous-revision>
Create Date: <auto-generated>
"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '<auto-generated>'
down_revision = '<previous-revision>'
branch_labels = None
depends_on = None

def upgrade():
    # Drop partial index
    op.drop_index('idx_bookmarks_user_not_deleted', table_name='bookmarks')

    # Drop deleted_at column
    op.drop_column('bookmarks', 'deleted_at')

def downgrade():
    # Re-add deleted_at column
    op.add_column('bookmarks',
        sa.Column('deleted_at', postgresql.TIMESTAMP(timezone=True), nullable=True)
    )

    # Re-create partial index
    op.execute('''
        CREATE INDEX idx_bookmarks_user_not_deleted
        ON bookmarks (user_id, created_at DESC)
        WHERE deleted_at IS NULL
    ''')
```

## Files to Modify

### Python Code
- `genonaut/api/repositories/bookmark_repository.py`
  - Remove soft_delete() method (lines 303-326)
  - Remove deleted_at filters from queries (lines 49, 103, etc.)
- `genonaut/db/schema.py`
  - Remove deleted_at column definition (line 1462)
  - Remove partial index (lines 1501-1502)
  - Update Bookmark docstring (line 1449)

### Database Migration
- Create new migration file in `genonaut/db/migrations/versions/`
- Apply to all environments: dev, demo, test

## Why Low Priority?

1. **No functional impact**: The deprecated code is not causing any issues
2. **No performance impact**: One unused column and index is negligible overhead
3. **No urgency**: Cleanup can be done during regular maintenance
4. **Safe to defer**: The hard-delete implementation is working correctly

## When to Do This

Good times to tackle this cleanup:
- During a scheduled database maintenance window
- When making other bookmark-related schema changes
- As part of a broader "technical debt cleanup" sprint
- When migrating to a new environment (good time to clean schema)

## References

- Original issue: Bookmarks couldn't be re-created after deletion
- Implementation: notes/bookmark-delete.md
- Related PR/commit: (to be added when changes are committed)
