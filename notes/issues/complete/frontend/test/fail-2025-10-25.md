# E2E Test Failures - Investigation Complete (2025-10-25)

## ROOT CAUSES IDENTIFIED - Browser Investigation Complete

Using Playwright MCP tools, I directly tested the app in browser and found actual root causes.

### Issue #1: Analytics Tests Use Wrong URL (16 failures)
- **Problem**: Tests navigate to `/analytics` which redirects to `/dashboard`
- **Actual Route**: `/settings/analytics` (works correctly)
- **Fix**: Update `analytics-real-api.spec.ts` to use `/settings/analytics`

### Issue #2: TagCardinalityCard Recharts Infinite Loop (3 failures)
- **Problem**: React infinite loop error in Tag Cardinality component
- **Error**: `Maximum update depth exceeded` at `recharts.js:32149:5`
- **Fix**: Fix state management in `TagCardinalityCard.tsx`

### Issue #3: Image View & Tag Rating Work But Tests Fail (6 failures)
- **Problem**: Features work in browser but tests fail
- **Investigation**: Gallery, image view, tag pages all load correctly
- **Fix**: Debug tests individually for timing/wait issues

See `tag-key-refactor-fix-tests-troubleshooting.md` for complete investigation details.

---

## Task List

### Image View Page Tests
- [ ] `displays image details and metadata` - image-view.spec.ts:5:3
- [ ] `navigates to tag detail page when tag chip is clicked` - image-view.spec.ts:48:3
- [ ] `back button returns to previous page` - image-view.spec.ts:110:3
- [ ] `does not show React duplicate key warnings for tags` - image-view.spec.ts:157:3

### Tag Rating Tests
- [ ] `should allow user to rate a tag` - tag-rating.spec.ts:16:3
- [ ] `should update existing rating` - tag-rating.spec.ts:85:3
- [ ] `should persist rating across page refreshes` - tag-rating.spec.ts:155:3

### Generation Tests
- [ ] `should successfully submit a generation job with real API` - generation.spec.ts:8:3

---

## Common Failure Patterns

### Pattern 1: Analytics Tests Navigate to Wrong URL (16 tests)

**BROWSER INVESTIGATION RESULT**: Analytics page works at `/settings/analytics` but tests use `/analytics`

**Affected Tests:**
- All analytics-real-api.spec.ts tests (16 tests)

**Actual Behavior (confirmed in browser):**
- Route `/analytics` does not exist, redirects to `/dashboard`
- Route `/settings/analytics` works correctly and loads AnalyticsPage
- Route Analytics section loads data ✅
- Generation Analytics section loads (empty but valid) ✅
- Tag Cardinality section throws infinite loop error ❌

**Fix Required:**
```typescript
// In analytics-real-api.spec.ts, change:
await page.goto('/analytics')

// To:
await page.goto('/settings/analytics')
```

**Database Status (confirmed):**
- API server connected to `genonaut_demo` database
- Database has 100+ content_items, 101 tags, 57 users
- Database is NOT empty! Previous hypothesis was wrong.

---

### Pattern 2: Image View & Tag Rating Tests (6 tests)

**BROWSER INVESTIGATION RESULT**: All features work correctly, tests likely have timing issues

**Affected Tests:**
- Image View tests (3 tests)
- Tag Rating tests (3 tests)

**Actual Behavior (confirmed in browser):**
- Gallery page loads with 25+ items ✅
- Image view page works when clicking items ✅
- Tag hierarchy loads with 106 tags ✅
- Tag detail pages load: `/tags/anime` works ✅
- Tag refactor successful - uses tag names not UUIDs! ✅
- Rating component displays and functional ✅

**Why Tests May Be Failing:**
- Timing/wait conditions not adequate for data loading
- React Query cache state during tests
- Selector updates needed after refactor
- Test setup/teardown issues

**Fix Required:**
- Run each test individually to see specific error
- Add proper wait conditions for React Query data loading
- Update any selectors that may have changed during refactor

---

### Pattern 3: TagCardinalityCard Recharts Infinite Loop (3 tests)

**BROWSER INVESTIGATION RESULT**: React infinite loop in Tag Cardinality visualization component

**Affected Tests:**
- Tag Cardinality section tests (3 tests) in analytics-real-api.spec.ts

**Actual Behavior (confirmed in browser):**
- Navigate to `/settings/analytics` works
- Route Analytics section renders correctly ✅
- Generation Analytics section renders correctly ✅
- Tag Cardinality section triggers React error ❌
- ErrorBoundary catches error and shows fallback UI
- Tests look for tag cardinality elements but find error fallback instead

**Error Message:**
```
Error: Maximum update depth exceeded. This can happen when a component repeatedly
calls setState inside componentWillUpdate or componentDidUpdate. React limits the
number of nested updates to prevent infinite loops.
```

**Stack Trace:** `recharts.js:32149:5`

**Fix Required:**
- Fix state management in `frontend/src/components/analytics/TagCardinalityCard.tsx`
- Likely causes:
  - setState call in render method
  - Missing useEffect dependency
  - ResponsiveContainer configuration issue
  - Recharts ref callback triggering setState

---

## Individual Test Details

### Image View: displays image details and metadata

**Test File:** `frontend/tests/e2e/image-view.spec.ts:5:3`

**Test Flow:**
1. Navigate to `/gallery`
2. Wait for gallery results or empty state
3. Check if results visible, if not -> fail with "missing data" error
4. Click first image card
5. Verify navigation to `/view/{id}`
6. Verify page elements present

**Current Status:** Fails at step 3 - sees empty state despite data existing

**Investigation Needed:**
- [ ] Verify API endpoint query parameters
- [ ] Check if user_id in query matches test data
- [ ] Verify content_items have required fields for gallery display
- [ ] Check network tab in test browser to see actual API response

---

### Image View: navigates to tag detail page when tag chip is clicked

**Test File:** `frontend/tests/e2e/image-view.spec.ts:48:3`

**Test Flow:**
Same as above, plus:
6. Find and click tag chip
7. Verify navigation to `/tags/{tagName}`
8. Verify tag detail page loads

**Current Status:** Fails at step 3 (same as above)

---

### Image View: back button returns to previous page

**Test File:** `frontend/tests/e2e/image-view.spec.ts:110:3`

**Test Flow:**
Same setup, then:
6. Click back button on view page
7. Verify navigation back to `/gallery`

**Current Status:** Fails at step 3 (same as above)

---

### Image View: does not show React duplicate key warnings for tags

**Test File:** `frontend/tests/e2e/image-view.spec.ts:157:3`

**Test Flow:**
1. Listen for console warnings
2. Navigate to gallery and open image view
3. Wait for tags to render
4. Check no duplicate key warnings in console

**Current Status:** Fails at gallery load (same as above)

---

### Tag Rating: should allow user to rate a tag

**Test File:** `frontend/tests/e2e/tag-rating.spec.ts:16:3`

**Test Flow:**
1. Navigate to `/gallery`
2. Click sidebar toggle to show tags
3. Get first tag name from sidebar
4. Navigate to tag detail page
5. Rate the tag
6. Verify rating saved

**Current Status:** Fails at step 2 - can't find sidebar toggle

**Investigation Needed:**
- [ ] Check if sidebar toggle exists when gallery is empty
- [ ] Verify sidebar toggle data-testid in GalleryPage component
- [ ] Check if sidebar is conditionally rendered

---

### Tag Rating: should update existing rating

**Test File:** `frontend/tests/e2e/tag-rating.spec.ts:85:3`

**Test Flow:**
Same as above, plus:
6. Change rating
7. Verify update saved

**Current Status:** Fails at step 2 (same as above)

---

### Tag Rating: should persist rating across page refreshes

**Test File:** `frontend/tests/e2e/tag-rating.spec.ts:155:3`

**Test Flow:**
Same as rating test, plus:
7. Refresh page
8. Verify rating persists

**Current Status:** Fails at step 2 (same as above)

---

### Generation: should successfully submit a generation job with real API

**Test File:** `frontend/tests/e2e/generation.spec.ts:8:3`

**Test Flow:**
1. Navigate to `/generate`
2. Wait for form to load
3. Fill prompt with "cat"
4. Click "Generate" button
5. Wait for success OR error indicator (10s timeout)
6. Fail if error, succeed if success

**Current Status:** Fails at step 5 - timeout, neither success nor error appears

**Investigation Needed:**
- [ ] Check Celery worker status
- [ ] Check ComfyUI mock service status
- [ ] Check API logs during generation submission
- [ ] Query database for generation_jobs created during test
- [ ] Verify database sequences (generation_jobs, content_items)
- [ ] Check if generation creates duplicate key errors
- [ ] Verify notification system working

---

## Database State Investigation

### Current Setup
- Test database (`genonaut_test`): Has 100 content_items
- Demo database (`genonaut_demo`): Unknown state, possibly different data
- API server running: Connected to `local-demo` database (not `local-test`)

### Required Actions
1. Determine which database each test type should use
2. Document test database expectations
3. Add database name to API health endpoint
4. Ensure test runners start correct API server
5. Consider if tests should run against demo database instead

---

## Broken Scripts

### seed_tags_from_content.py

**Status:** Broken due to schema migration

**Error:**
```
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedColumn)
column "tags_old" does not exist
LINE 2: SELECT DISTINCT jsonb_array_elements_text(tags_old) as tag_name
```

**Cause:**
- Script references `tags_old` column
- Column was dropped in migration: `4b0146ebf04b - Drop tags_old columns`
- Script needs updating to use new tag schema (junction table `content_tags`)

**Impact:**
- Can't seed tags for test database using this script
- Tests expect tags to exist for tag rating functionality
- May need alternative seeding approach

**Fix Required:**
- Update script to query `content_tags` junction table
- Or query tags from content_items.item_metadata JSONB
- Or create new seed script for current schema
