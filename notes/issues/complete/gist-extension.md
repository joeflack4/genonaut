# Enabling `pg_trgm` and Creating Trigram Indexes *without Alembic*

> **Goal:** Load the `pg_trgm` extension and create trigram indexes from **SQLAlchemy code**, *not via Alembic migrations*.

---

## Overview
- Alembic **autogenerate** will **not** emit `CREATE EXTENSION` statements.
- Do the extension load and index creation in app/bootstrap code.
- Keep it **idempotent**: use `IF NOT EXISTS` and `checkfirst=True`.

---

## 1) One‚Äëtime Bootstrap (run at startup) ‚Äî *example*
```python
# example
from sqlalchemy import text

def ensure_pg_trgm(engine):
    # Runs once; safe to call repeatedly
    with engine.begin() as conn:
        conn.execute(text("CREATE EXTENSION IF NOT EXISTS pg_trgm;"))
```
Call `ensure_pg_trgm(engine)` **before** index creation.

---

## 2) Metadata Event Hook (fires on create_all) ‚Äî *example*
```python
# example
from sqlalchemy import event, DDL

event.listen(
    Base.metadata,
    "before_create",
    DDL("CREATE EXTENSION IF NOT EXISTS pg_trgm")
)
```
> Fires only when `Base.metadata.create_all(engine)` would actually create objects.

---

## 3) Define Trigram Indexes on Models ‚Äî *example*
```python
# example
import sqlalchemy as sa
from sqlalchemy import Index
from sqlalchemy.dialects.postgresql import TEXT

class Comfy(Base):
    __tablename__ = "comfyui_generation_requests"
    id = sa.Column(sa.Integer, primary_key=True)
    negative_prompt = sa.Column(TEXT)

Index(
    "idx_comfyui_gen_negative_prompt_gist",
    Comfy.negative_prompt,
    postgresql_using="gist",
    postgresql_ops={"negative_prompt": "gist_trgm_ops"},
)
```
Create them programmatically (outside Alembic):
```python
# example
def ensure_indexes(engine):
    for idx in Comfy.__table__.indexes:
        idx.create(bind=engine, checkfirst=True)
```

---

## Recommended Execution Order (Checklist)
- [ ] **Privileges:** Confirm your DB user can run `CREATE EXTENSION`.
- [ ] **Start app/bootstrap:**
   - [ ] Call `ensure_pg_trgm(engine)`.
   - [ ] Call `ensure_indexes(engine)` (or loop over all models' `__table__.indexes`).
- [ ] **Verify:**
   - [ ] `SELECT extname FROM pg_extension WHERE extname = 'pg_trgm';`
   - [ ] `SELECT indexname FROM pg_indexes WHERE tablename = 'comfyui_generation_requests';`
- [ ] **Search tests:** Run ILIKE/similarity/regex queries and confirm the planner uses the index (`EXPLAIN ANALYZE`).

## Attempted Solutions and Results

### ‚úÖ Approach 1: SQLAlchemy Event Listeners
- [x] Added `event.listen(Base.metadata, "before_create", DDL("CREATE EXTENSION IF NOT EXISTS pg_trgm").execute_if(dialect="postgresql"))`
- [x] Added utility functions `ensure_pg_trgm_extension()` and `ensure_trigram_indexes()`
- [x] Updated database initialization to call these functions
- [ ] **Result: FAILED** - Event listeners only fire during `create_all()`, not during Alembic migrations

### üîÑ Approach 2: Alembic env.py Extension Hook
- [x] Modify `genonaut/db/migrations/env.py` to ensure extension before migrations
- [x] Add extension check in `run_migrations_online()` with PostgreSQL detection
- [x] Added error handling with graceful fallback
- [x] Test with fresh migration
- [x] **Result: FAILED** - Extension installed but transaction isolation issue prevented GiST indexes from seeing it

### üîÑ Approach 3: Manual Migration Extension
- [x] Add `CREATE EXTENSION` directly to migration files
- [x] Modify autogenerated migration `410155f8d5f4_gist_indexes.py` to include extension setup
- [x] Added `op.execute("CREATE EXTENSION IF NOT EXISTS pg_trgm;")` at start of upgrade()
- [x] Removed env.py hook to avoid conflicts
- [x] Test with manually modified migration
- [x] **Result: FAILED** - Extension command was lost during fresh autogeneration

### üîÑ Approach 4: Pre-Migration Database Setup
- [x] Manually install extension before running migrations
- [x] Use `PGPASSWORD=chocolateRainbows858 psql -h localhost -U genonaut_admin -d genonaut -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;"`
- [x] Verified extension installation and operator class availability
- [x] Confirmed `gist_trgm_ops` and `gin_trgm_ops` are now available
- [x] Test migration with pre-installed extension
- [x] **Result: PARTIAL SUCCESS** - Worked but only installed on dev DB, not demo DB

### ‚úÖ Approach 5: Automated Extension Installation System
- [x] Create `schema_extensions.py` with extension management utilities
- [x] Add CLI command for installing extensions with database_url parameter
- [x] Ensure init.py reliably installs all required extensions (GIN, GiST)
- [x] Update Makefile commands (migrate-demo, migrate-dev, migrate-test) to run extension installation first
- [x] Test CLI extension installation and verification
- [x] Verify trigram operator classes are available after installation
- [x] **Result: SUCCESS** - ‚úÖ Complete automated extension management system implemented

---

## ‚úÖ FINAL SOLUTION SUMMARY

**Problem Solved:** GiST trigram indexes failed with "operator class gist_trgm_ops does not exist" because `pg_trgm` extension wasn't installed during migrations.

**Solution Implemented:** Automated extension installation system that runs before all migrations.

### Key Components:
1. **`genonaut/db/schema_extensions.py`** - Centralized extension management with CLI
2. **Updated `genonaut/db/init.py`** - Uses centralized system for database initialization
3. **Updated `Makefile`** - All migrate commands now install extensions first

### Usage:
```bash
# Manual extension management
python -m genonaut.db.schema_extensions install $DATABASE_URL_DEMO
python -m genonaut.db.schema_extensions verify $DATABASE_URL_DEMO

# Automated via Makefile (now includes extension installation)
make migrate-demo  # Installs extensions + runs migration
make migrate-dev   # Installs extensions + runs migration
make migrate-test  # Installs extensions + runs migration
```

### Benefits:
- ‚úÖ **No more manual extension installation needed**
- ‚úÖ **Works for fresh database initialization**
- ‚úÖ **Works for existing database migrations**
- ‚úÖ **Consistent across dev/demo/test environments**
- ‚úÖ **Prevents future extension-related migration failures**
- ‚úÖ **Smart detection** - Only installs missing extensions
- ‚úÖ **Clean output** - Minimal verbosity when everything is already set up

---

## Notes & Tips
- Use **GiST** (`gist_trgm_ops`) for KNN ranking (`ORDER BY col <-> 'q'`).
- Use **GIN** (`gin_trgm_ops`) for fast boolean filters (`ILIKE`, regex, `%` similarity).
- Keep one type at first (usually **GiST**). Add the other **only if** profiling shows clear wins.
- This approach keeps extension logic in code; no edits to `alembic/versions/` needed.

---

## Troubleshooting
- **ERROR: operator class ‚Äúgist_trgm_ops‚Äù does not exist** ‚Üí `pg_trgm` not installed in this DB; run the bootstrap.
- **Permission denied** ‚Üí connect as a role with permission to `CREATE EXTENSION`.
- **Index not created** ‚Üí ensure `ensure_indexes(engine)` runs *after* models are imported.
